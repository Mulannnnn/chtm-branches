<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ระบบตรวจสอบสาขา</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #5f0e8a; --accent: #f5eb36; --error: #f90000; }
        body { margin: 0; font-family: 'Noto Sans Thai', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 15px; background: white; display: flex; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; }
        #main { display: flex; flex: 1; position: relative; overflow: hidden; }
        #map { flex: 1; z-index: 1; }
        #side-panel { width: 350px; background: white; border-left: 1px solid #ddd; overflow-y: auto; z-index: 10; }
        .branch-card { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .branch-card:hover { background: #f9f9f9; }
        
        /* แก้ไขตำแหน่งปุ่มให้ลอยเหนือ Side Panel และเห็นชัด */
        .fab-location {
            position: absolute;
            bottom: 25px;
            right: 370px; /* ขยับออกมาจากแถบข้าง */
            width: 55px;
            height: 55px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 999;
        }

        /* Pin สีแดง */
        .red-pin {
            width: 20px;
            height: 20px;
            background: var(--error);
            border: 2px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
        }
    </style>
</head>
<body>

<div id="header">
    <div style="font-weight:bold; color:var(--primary);">ระบบตรวจสอบสาขา</div>
    <div style="font-size:12px; color:gray;">ข้อมูล Real-time</div>
</div>

<div id="main">
    <div id="map"></div>
    
    <div class="fab-location" onclick="findMe()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--primary)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-12-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
    </div>

    <div id="side-panel">
        <div style="padding:15px; border-bottom:2px solid var(--accent); font-weight:bold;">สาขาใกล้เคียง</div>
        <div id="info-content"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRY_i5LWW_vfD8Dsxd2kwiLN50ZZhg9LZcK-JRMoZZu3TXYolGI4JDGbUE9J51z-IMrEQvtjkLQyqXP/pub?output=csv';

    var map = L.map('map', {zoomControl: false}).setView([13.75, 100.50], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var markersLayer = L.layerGroup().addTo(map);
    var userMarker;

    function loadData() {
        Papa.parse(sheetUrl, {
            download: true,
            // ปิด header: true ชั่วคราว เพื่อดึงตามลำดับคอลัมน์ ลดปัญหาชื่อหัวตารางผิด
            header: false, 
            skipEmptyLines: true,
            complete: function(results) {
                renderBranches(results.data);
            }
        });
    }

    function renderBranches(data) {
        const container = document.getElementById('info-content');
        container.innerHTML = '';
        markersLayer.clearLayers();

        // เริ่มที่ i=1 เพื่อข้ามหัวตาราง
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            
            // ปรับตรงนี้ตามจริง: คอลัมน์ A=row[0], B=row[1], C=row[2]
            // สมมติ Name อยู่ A, Lat อยู่ B, Long อยู่ C
            const name = row[0] || "ไม่ระบุชื่อ";
            const lat = parseFloat(row[1]); 
            const lng = parseFloat(row[2]);

            if (!isNaN(lat) && !isNaN(lng)) {
                // สร้างพินแดง
                const icon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div class="red-pin"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                });

                L.marker([lat, lng], {icon: icon}).addTo(markersLayer).bindPopup(name);

                // สร้างการ์ด
                const card = document.createElement('div');
                card.className = 'branch-card';
                card.innerHTML = `<strong>${name}</strong><br><small>พิกัด: ${lat}, ${lng}</small>`;
                card.onclick = () => map.flyTo([lat, lng], 15);
                container.appendChild(card);
            }
        }
    }

    function findMe() { map.locate({setView: true, maxZoom: 15}); }
    
    map.on('locationfound', function(e) {
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.circleMarker(e.latlng, {radius: 8, color: '#5f0e8a', fillColor: '#f5eb36', fillOpacity: 1}).addTo(map);
    });

    loadData();
</script>
</body>
</html>
