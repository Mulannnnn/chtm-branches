<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #5f0e8a; --accent: #f5eb36; --error: #f90000; --user-loc: #2A56FF; }
        body { margin: 0; font-family: 'Noto Sans Thai', sans-serif; display: flex; flex-direction: column; height: 100vh; background: #f4f4f4; }
        #header { padding: 15px 20px; background: white; display: flex; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        #main { display: flex; flex: 1; position: relative; overflow: hidden; }
        #map { flex: 1; z-index: 1; }
        
        /* Side Panel */
        #side-panel { width: 380px; background: white; border-left: 1px solid #ddd; overflow-y: auto; z-index: 10; }
        .panel-header { padding: 20px; border-bottom: 2px solid var(--accent); position: sticky; top: 0; background: white; z-index: 11; font-weight: bold; }
        
        /* Branch Card */
        .branch-card { padding: 20px; border-bottom: 1px solid #eee; transition: 0.2s; }
        .branch-card:hover { background: #fdfdfd; }
        .branch-name { font-weight: 700; color: var(--primary); font-size: 1.1rem; margin-bottom: 8px; }
        .info-row { font-size: 0.9rem; margin-bottom: 5px; color: #444; }
        .btn-nav { 
            display: inline-block; margin-top: 12px; padding: 8px 15px; 
            background: var(--primary); color: white; text-decoration: none; 
            border-radius: 5px; font-size: 0.85rem; transition: 0.3s;
        }
        .btn-nav:hover { background: #4a0a6b; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Custom Markers */
        .red-pin { width: 22px; height: 22px; background: var(--error); border: 2px solid white; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); box-shadow: -1px 1px 4px rgba(0,0,0,0.3); }
        .user-location-dot { width: 15px; height: 15px; background: var(--user-loc); border: 3px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

        .fab-location {
            position: absolute; bottom: 30px; right: 400px; width: 55px; height: 55px;
            background: var(--accent); border-radius: 50%; display: flex; align-items: center;
            justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 999;
        }
        
        @media (max-width: 768px) {
            #main { flex-direction: column; }
            #side-panel { width: 100%; height: 40%; }
            .fab-location { right: 20px; bottom: 42%; }
        }
    </style>
</head>
<body>

<div id="header">
    <div style="font-weight:700; color:var(--primary);">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤</div>
    <div style="font-size:12px; color:#666;">Data: Google Sheets</div>
</div>

<div id="main">
    <div id="map"></div>
    
    <div class="fab-location" onclick="findMe()" title="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="var(--primary)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-12-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
    </div>

    <div id="side-panel">
        <div class="panel-header">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì</div>
        <div id="info-content"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRY_i5LWW_vfD8Dsxd2kwiLN50ZZhg9LZcK-JRMoZZu3TXYolGI4JDGbUE9J51z-IMrEQvtjkLQyqXP/pub?output=csv';

    var map = L.map('map', {zoomControl: false}).setView([13.75, 100.50], 8);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    var markersLayer = L.layerGroup().addTo(map);
    var userMarker;

    function loadData() {
        Papa.parse(sheetUrl, {
            download: true,
            header: false, // ‡πÉ‡∏ä‡πâ Index ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
            skipEmptyLines: true,
            complete: function(results) {
                renderBranches(results.data);
            }
        });
    }

    function renderBranches(data) {
        const container = document.getElementById('info-content');
        container.innerHTML = '';
        markersLayer.clearLayers();

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà i=1 ‡∏Ç‡πâ‡∏≤‡∏° Header
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const name = row[0] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠";
            const lat = parseFloat(row[1]); // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Lng ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏Ñ‡∏∑‡∏≠ Lat
            const lng = parseFloat(row[2]); // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Long
            const people = row[3] || "-";   // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå People
            const note = row[4] || "";      // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Note

            if (!isNaN(lat) && !isNaN(lng)) {
                // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="red-pin"></div>`,
                    iconSize: [22, 22],
                    iconAnchor: [11, 22]
                });

                L.marker([lat, lng], {icon: icon}).addTo(markersLayer).bindPopup(`<b>${name}</b>`);

                // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ã‡∏î‡πå‡∏ö‡∏≤‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const card = document.createElement('div');
                card.className = 'branch-card';
                card.innerHTML = `
                    <div class="branch-name">${name}</div>
                    <div class="info-row">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö: <b>${people}</b> ‡∏ó‡πà‡∏≤‡∏ô</div>
                    ${note ? `<div class="info-row">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${note}</div>` : ''}
                    <div class="info-row" style="color:#888; font-size:11px; margin-top:5px;">‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat}, ${lng}</div>
                    <a class="btn-nav" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank">
                        üöÄ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps
                    </a>
                `;
                card.onclick = (e) => {
                    if(e.target.tagName !== 'A') map.flyTo([lat, lng], 15);
                };
                container.appendChild(card);
            }
        }
    }

    function findMe() { map.locate({setView: true, maxZoom: 15}); }
    
    map.on('locationfound', function(e) {
        if (userMarker) map.removeLayer(userMarker);
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏û‡∏¥‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô GPS
        const userIcon = L.divIcon({
            className: 'user-div-icon',
            html: `<div class="user-location-dot"></div>`,
            iconSize: [15, 15],
            iconAnchor: [7, 7]
        });
        userMarker = L.marker(e.latlng, {icon: userIcon}).addTo(map);
        userMarker.bindPopup("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà").openPopup();
    });

    loadData();
</script>
</body>
</html>
